<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>福州大学校园管理系统 - 学生证展示</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    
    <style>
* {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      }
      :root {
        --primary-color: #1a6bc4;
        --secondary-color: #0d4e8c;
        --accent-color: #1a6bc4;
        --light-color: #f0f2f5;
        --dark-color: #333;
        --sidebar-width: 250px;
        --sidebar-collapsed-width: 70px;
        --header-height: 70px;
      }
      body {
        background: #f0f2f5;
        color: #333;
        min-height: 100vh;
        line-height: 1.6;
      }
      .container {
        display: flex;
        min-height: 100vh;
      }

      /* 侧边栏 */
      .sidebar {
        width: var(--sidebar-width);
        background: linear-gradient(
          to bottom,
          var(--secondary-color) 0%,
          var(--primary-color) 100%
        );
        color: #fff;
        transition: all 0.3s;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        z-index: 100;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
      }
      .sidebar.collapsed {
        width: var(--sidebar-collapsed-width);
      }
      .sidebar-header {
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        height: var(--header-height);
      }
      .logo {
        display: flex;
        align-items: center;
      }
      .logo i {
        font-size: 1.5rem;
        margin-right: 10px;
      }
      .logo h1 {
        font-size: 1.2rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
      }
      .sidebar.collapsed .logo h1 {
        display: none;
      }
      .toggle-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.2rem;
        cursor: pointer;
        transition: 0.3s;
      }
      .sidebar.collapsed .toggle-btn {
        transform: rotate(180deg);
      }
      .sidebar-menu {
        padding: 20px 0;
      }
      .menu-item {
        padding: 12px 20px;
        display: flex;
        align-items: center;
        color: rgba(255, 255, 255, 0.85);
        text-decoration: none;
        transition: 0.2s;
        border-left: 3px solid transparent;
        cursor: pointer;
      }
      .menu-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border-left-color: var(--accent-color);
      }
      .menu-item.active {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        border-left-color: #fff;
      }
      .menu-item i {
        margin-right: 15px;
        font-size: 1.1rem;
        width: 20px;
        text-align: center;
      }
      .sidebar.collapsed .menu-item span {
        display: none;
      }
      .menu-divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 15px 0;
      }

      /* 主内容 */
      .main-content {
        flex: 1;
        margin-left: var(--sidebar-width);
        transition: margin-left 0.3s;
      }
      .sidebar.collapsed ~ .main-content {
        margin-left: var(--sidebar-collapsed-width);
      }
      .header {
        height: var(--header-height);
        background: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        position: sticky;
        top: 0;
        z-index: 99;
      }
      .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--dark-color);
        cursor: pointer;
      }
      .user-info {
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      .user-info:hover {
        filter: brightness(0.95);
      }
      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(
          to bottom,
          var(--secondary-color) 0%,
          var(--primary-color) 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        margin-right: 10px;
      }
      .page-content {
        padding: 30px;
      }
      .welcome-section {
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--secondary-color)
        );
        color: #fff;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .welcome-section h1 {
        font-size: 1.8rem;
        margin-bottom: 10px;
      }
      .welcome-section p {
        opacity: 0.95;
        font-size: 1.08rem;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }
      .dashboard-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 25px;
        transition: 0.3s;
        cursor: pointer;
      }
      .dashboard-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
      }
      .card-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }
      .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--secondary-color)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 1.5rem;
        margin-right: 15px;
      }
      .card-header h3 {
        color: var(--dark-color);
        font-size: 1.2rem;
      }
      .card-content p {
        color: #666;
      }

      .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }
      .action-btn {
        background: #fff;
        border: none;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.3s;
      }
      .action-btn:hover {
        background: var(--primary-color);
        color: #fff;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(26, 107, 196, 0.3);
      }
      .action-btn i {
        font-size: 1.8rem;
        margin-bottom: 10px;
      }

      .footer {
        text-align: center;
        padding: 20px;
        color: #666;
        font-size: 0.9rem;
        border-top: 1px solid #eee;
        margin-top: 30px;
      }

      .function-page {
        display: none;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 30px;
        margin-bottom: 30px;
      }
      .function-page.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .page-title {
        font-size: 1.8rem;
        color: var(--dark-color);
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light-color);
      }
      .placeholder-content {
        text-align: center;
        padding: 60px 20px;
        color: #888;
      }
      .placeholder-content i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #dfe5ee;
      }
      .placeholder-content h3 {
        font-size: 1.5rem;
        margin-bottom: 15px;
      }
      .back-btn,
        .edit-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: 0.3s;
        margin-top: 20px;
      }
      .back-btn:hover,
        .edit-btn:hover {
        background: var(--secondary-color);
      }

      /* 宿舍报修 */
      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 20px 0 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
      }
      .repair-section {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .repair-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .add-repair-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: 0.3s;
      }
      .add-repair-btn:hover {
        background: var(--secondary-color);
      }
      .repair-list {
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
      }
      .repair-item {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        transition: 0.2s;
      }
      .repair-item:hover {
        background: #f9f9f9;
      }
      .repair-item:last-child {
        border-bottom: none;
      }
      .repair-type {
        font-weight: 700;
        margin-bottom: 6px;
        color: var(--primary-color);
      }
      .repair-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        margin-bottom: 8px;
      }
      .status-evaluated {
        background: #e8f5e8;
        color: #4caf50;
      }
      .status-transferred {
        background: #fff3cd;
        color: #856404;
      }
      .repair-time,
      .repair-desc {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
      }
      .no-records {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      .form-page,
      .detail-page {
        display: none;
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .form-header,
      .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
      }
      .form-back-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 16px;
      }
      .form-back-btn i {
        margin-right: 6px;
      }
      .form-group {
        margin-bottom: 18px;
      }
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
      }
      .required::after {
        content: "*";
        color: #f00;
        margin-left: 4px;
      }
      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }
      .form-textarea {
        height: 100px;
        resize: vertical;
      }
      .char-count {
        text-align: right;
        font-size: 12px;
        color: #999;
        margin-top: 5px;
      }
      .image-upload {
        border: 1px dashed #ddd;
        border-radius: 6px;
        padding: 20px;
        text-align: center;
        color: #999;
        cursor: pointer;
      }
      .image-upload-icon {
        font-size: 24px;
        margin-bottom: 10px;
      }
      .submit-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
        transition: 0.3s;
      }
      .submit-btn:hover {
        background: var(--secondary-color);
      }

      /* 报修详情 + 评价 */
      .detail-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 18px;
      }
      .detail-item {
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 6px;
        padding: 12px;
      }
      .detail-label {
        font-size: 12px;
        color: #777;
        margin-bottom: 5px;
      }
      .detail-value {
        font-weight: 600;
        color: #222;
      }
      .evaluation-section {
        margin-top: 14px;
        border-top: 1px dashed #e0e0e0;
        padding-top: 12px;
      }
      .evaluation-textarea {
        width: 100%;
        min-height: 90px;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        resize: vertical;
        margin: 10px 0;
      }
      .submit-evaluation {
        background: #1db954;
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
      }
      .submit-evaluation:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      @media (max-width: 992px) {
        .sidebar {
          width: var(--sidebar-collapsed-width);
        }
        .sidebar .logo h1,
        .sidebar .menu-item span {
          display: none;
        }
        .main-content {
          margin-left: var(--sidebar-collapsed-width);
        }
        .dashboard-grid {
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }
      }
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }
        .sidebar.active {
          transform: translateX(0);
          width: var(--sidebar-width);
        }
        .sidebar.active .logo h1,
        .sidebar.active .menu-item span {
          display: block;
        }
        .main-content {
          margin-left: 0;
        }
        .mobile-menu-btn {
          display: block;
        }
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
        .repair-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .add-repair-btn {
          margin-top: 10px;
        }
        .detail-content {
          grid-template-columns: 1fr;
        }
      }

#student-card { padding: 20px; }
    
/* ===== Modal ===== */
.modal{display:none;position:fixed;inset:0;z-index:9999;}
.modal.show{display:block;}
.modal-mask{position:absolute;inset:0;background:rgba(0,0,0,.35);}
.modal-panel{position:relative;width:min(920px,calc(100vw - 32px));max-height:calc(100vh - 80px);overflow:auto;margin:40px auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.18);}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid #eee;}
.modal-body{padding:16px 18px;}
.modal-footer{display:flex;gap:10px;justify-content:flex-end;padding:14px 18px;border-top:1px solid #eee;}
.icon-btn{background:none;border:none;font-size:18px;cursor:pointer;color:#666;}
.form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;}
.field label{display:block;font-size:13px;color:#555;margin-bottom:6px;}
.field input{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;outline:none;}
.field input:focus{border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(26,107,196,.15);}
.hint{font-size:12px;color:#888;margin-top:6px;}
.note{display:flex;gap:10px;align-items:flex-start;margin-top:14px;padding:12px;border-radius:10px;background:#f7f9ff;color:#456;}
.note code{background:#eef2ff;padding:2px 6px;border-radius:6px;}
.btn{padding:10px 14px;border:none;border-radius:10px;background:linear-gradient(to right,var(--primary-color),var(--secondary-color));color:#fff;cursor:pointer;font-weight:600;}
.btn.ghost{background:#f2f4f7;color:#333;}
@media (max-width: 720px){.form-grid{grid-template-columns:1fr;}}

</style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <i class="fas fa-graduation-cap"></i>
            <h1>福州大学校园管理系统</h1>
          </div>
          <button class="toggle-btn" id="toggle-btn" title="收起/展开侧边栏">
            <i class="fas fa-chevron-left"></i>
          </button>
        </div>

        <div class="sidebar-menu">
          <a class="menu-item" href="/dashboard/"><i class="fas fa-home"></i><span>系统概览</span></a>
          <a class="menu-item" href="/face/"><i class="fas fa-user-check"></i><span>人脸识别</span></a>
          <a class="menu-item" href="/campus-map/"><i class="fas fa-map-marked-alt"></i><span>校园地图</span></a>
          <a class="menu-item" href="/repair/"><i class="fas fa-tools"></i><span>宿舍报修</span></a>
          <a class="menu-item active" href="/student-id/"><i class="fas fa-id-card"></i><span>学生证展示</span></a>
          <a class="menu-item" href="/love/"><i class="fas fa-heart"></i><span>宿舍表白墙</span></a>
          <a class="menu-item" href="/profile/"><i class="fas fa-user"></i><span>个人中心</span></a>
          <div class="menu-divider"></div>
          <a class="menu-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>退出登录</span></a>
        </div>
      </div>
      <div class="main-content">
        <div class="header">
          <button class="mobile-menu-btn" id="mobile-menu-btn">
            <i class="fas fa-bars"></i>
          </button>
          <div class="user-info" id="user-info" title="点击查看个人中心">
            <div class="user-avatar" id="user-avatar">学</div>
            <div>
              <div id="user-name">同学</div>
              <div id="user-college" style="font-size: 0.8rem; color: #666">学院</div>
            </div>
          </div>
        </div>

        <div class="page-content">
          <div class="function-page active" id="student-card">
        <div class="student-card-container">
            <div class="student-card">
                <div class="card-header">
                    <h2>福州大学学生证</h2>
                    <p>Fuzhou University Student ID Card</p>
                    <div class="university-logo">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="photo-section">
                        <div class="student-photo">
                            <!-- 在实际应用中，这里应该是学生的真实照片 -->
                            <!-- <img src="student_photo.jpg" alt="学生照片"> -->
                            <div class="photo-placeholder">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                        </div>
                        <div class="photo-label">学生照片</div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-row">
                            <div class="info-label">学号</div>
                            <div class="info-value student-id">--</div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">姓名</div>
                            <div class="info-value"><span class="student-name">--</span></div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">性别</div>
                            <div class="info-value"><span class="student-gender">--</span></div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">出生日期</div>
                            <div class="info-value"><span class="student-birthday">--</span></div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">入学时间</div>
                            <div class="info-value"><span class="student-enroll">--</span></div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">学院</div>
                            <div class="info-value"><span class="student-college">--</span></div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">专业</div>
                            <div class="info-value"><span class="student-major">--</span></div>
                        </div>
                        
                        
                        <div class="info-row">
                            <div class="info-label">年级</div>
                            <div class="info-value"><span class="student-grade">--</span></div>
                        </div>

                        <div class="info-row">
                            <div class="info-label">宿舍</div>
                            <div class="info-value"><span class="student-dorm">--</span></div>
                        </div>

<div class="info-row">
                            <div class="info-label">学历层次</div>
                            <div class="info-value"><span class="student-level">本科</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer">
                    <div class="issue-date"><strong>发证日期：</strong><span class="issue-date-val">--</span></div>
                    <div class="validity"><strong>有效期至：</strong><span class="validity-val">--</span></div>
                </div>
            </div>
        </div>
        
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:18px;"><button class="back-btn" id="back-to-main">返回系统概览</button><button class="edit-btn" id="edit-card">编辑学生证信息</button></div>
    </div>
        </div>

        
<div class="modal" id="editModal" aria-hidden="true">
  <div class="modal-mask" id="modalMask"></div>
  <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-header">
      <h3 id="modalTitle">编辑学生证信息</h3>
      <button class="icon-btn" id="closeModal" title="关闭"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field">
          <label>姓名</label>
          <input id="f_name" placeholder="例如：张三" />
        </div>
        <div class="field">
          <label>学院</label>
          <input id="f_college" placeholder="例如：计算机科学学院" />
        </div>
        <div class="field">
          <label>专业</label>
          <input id="f_major" placeholder="例如：计算机科学与技术" />
        </div>
        <div class="field">
          <label>年级</label>
          <input id="f_grade" placeholder="例如：2023级" />
        </div>

        <div class="field">
          <label>性别（可选）</label>
          <input id="f_gender" placeholder="男 / 女" />
          <div class="hint">可选项：若后端未实现 student-card 接口，会自动跳过保存。</div>
        </div>
        <div class="field">
          <label>出生日期（可选）</label>
          <input id="f_birthday" placeholder="YYYY-MM-DD 或 2004年9月1日" />
        </div>
        <div class="field">
          <label>入学时间（可选）</label>
          <input id="f_enroll" placeholder="YYYY-MM-DD 或 2023年9月1日" />
        </div>
        <div class="field">
          <label>发证日期（可选）</label>
          <input id="f_issue" placeholder="例如：2023年9月" />
        </div>
        <div class="field">
          <label>有效期至（可选）</label>
          <input id="f_valid" placeholder="例如：2027年7月" />
        </div>
        <div class="field">
          <label>照片URL（可选）</label>
          <input id="f_photo" placeholder="http(s)://..." />
        </div>
      </div>
      <div class="note">
        <i class="fas fa-info-circle"></i>
        <span>说明：姓名/学院/专业/年级 使用现有 <code>/api/auth/update</code> 更新；其余“可选字段”需要后端提供 <code>/api/student-card</code> 接口。</span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn ghost" id="cancelEdit">取消</button>
      <button class="btn" id="saveEdit">保存</button>
    </div>
  </div>
</div>

<div class="footer">福州大学校园管理系统 © 2025</div>
      </div>
    </div>
    <script>
  /* ======= 基础工具 & 登录守卫（同源，不写死端口） ======= */
  const ORIGIN = location.origin;
  const AUTH_API = `${ORIGIN}/api/auth`;
  const token = localStorage.getItem("token");

  function go(path) {
    location.href = path.startsWith("http") ? path : `${ORIGIN}${path}`;
  }

  // 允许 login 页不拦截；其余页无 token 直接回到登录
  if (!token && !location.pathname.startsWith("/login")) {
    alert("请先登录！");
    location.replace(`${ORIGIN}/login/`);
  }

  async function loadProfile() {
    // 先用缓存渲染（更快）
    try {
      const cached = JSON.parse(localStorage.getItem("user") || "null");
      if (cached) renderUser(cached);
    } catch {}

    // 再从后端刷新（更准）
    try {
      const res = await fetch(`${AUTH_API}/profile`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (!res.ok) throw new Error("profile not ok");
      const j = await res.json();
      const u = j?.data || j?.user || j;
      if (u) {
        localStorage.setItem("user", JSON.stringify(u));
        renderUser(u);
      }
    } catch (e) {
      // 没取到就保持缓存/默认
    }
  }

  function renderUser(u) {
    const name = u.real_name || u.name || u.username || "同学";
    const college = u.college || u.department || "学院";
    const avatarChar = name?.trim()?.[0] || "学";
    const nameEl = document.getElementById("user-name");
    const colEl = document.getElementById("user-college");
    const avEl = document.getElementById("user-avatar");
    if (nameEl) nameEl.textContent = name;
    if (colEl) colEl.textContent = college;
    if (avEl) avEl.textContent = avatarChar;
  }

  // 顶部个人资料卡
  document.addEventListener("DOMContentLoaded", () => {
    const userInfo = document.getElementById("user-info");
    if (userInfo) userInfo.addEventListener("click", () => go("/profile/"));

    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        go("/login/");
      });
    }

    // 侧边栏收起/展开
    const toggleBtn = document.getElementById("toggle-btn");
    if (toggleBtn) {
      toggleBtn.addEventListener("click", () => {
        document.getElementById("sidebar")?.classList.toggle("collapsed");
      });
    }

    // 移动端展开/收起
    const mobileBtn = document.getElementById("mobile-menu-btn");
    if (mobileBtn) {
      mobileBtn.addEventListener("click", () => {
        document.getElementById("sidebar")?.classList.toggle("active");
      });
    }

    // 点击主内容区域（小屏收起侧边栏）
    document.querySelector(".main-content")?.addEventListener("click", () => {
      if (innerWidth <= 768) document.getElementById("sidebar")?.classList.remove("active");
    });

    // 通用返回按钮
    document.querySelectorAll(".back-btn").forEach((btn) => {
      btn.addEventListener("click", () => go("/dashboard/"));
    });

    loadProfile();
  });
</script>
    
<script>
  /* ======= Student ID realtime read/write ======= */
  const ORIGIN2 = location.origin;
  const AUTH_API2 = `${ORIGIN2}/api/auth`;
  const CARD_API = `${ORIGIN2}/api/student-card`; // 可选：后端未实现也没关系
  const token2 = localStorage.getItem("token");

  function safeText(el, value) {
    if (!el) return;
    el.textContent = value == null || value === "" ? "--" : String(value);
  }

  function setPhoto(url) {
    const box = document.querySelector("#student-card .student-photo");
    if (!box) return;
    const img = box.querySelector("img");
    const placeholder = box.querySelector(".photo-placeholder");
    if (url) {
      if (placeholder) placeholder.style.display = "none";
      if (img) {
        img.src = url;
        img.style.display = "block";
      } else {
        const im = document.createElement("img");
        im.alt = "学生照片";
        im.src = url;
        box.prepend(im);
      }
    } else {
      if (img) img.style.display = "none";
      if (placeholder) placeholder.style.display = "";
    }
  }

  async function fetchJson(url, options = {}) {
    const res = await fetch(url, options);
    const contentType = res.headers.get("content-type") || "";
    const data = contentType.includes("application/json") ? await res.json().catch(() => null) : null;
    return { res, data };
  }

  async function loadStudentCard() {
    if (!token2) return;

    // 1) 读取基础资料（已存在接口）
    let u = null;
    try {
      const { res, data } = await fetchJson(`${AUTH_API2}/profile`, {
        headers: { Authorization: `Bearer ${token2}` },
      });
      if (!res.ok) throw new Error("profile failed");
      u = data?.data || data?.user || data;
      if (u) localStorage.setItem("user", JSON.stringify(u));
    } catch {
      // fallback local cache
      try { u = JSON.parse(localStorage.getItem("user") || "null"); } catch {}
    }

    // 映射已有字段（根据你项目 profile 页：student_no / building_no / room_no）
    const name = u?.real_name || u?.name || u?.username;
    const sid = u?.student_no || u?.student_id || u?.sid || u?.studentNo;
    const college = u?.college || u?.department;
    const major = u?.major || u?.specialty;
    const grade = u?.grade || u?.year;
    const dorm = (u?.building_no && u?.room_no) ? `${u.building_no}号楼 ${u.room_no}` : (u?.dorm || "");

    safeText(document.querySelector("#student-card .student-name"), name);
    safeText(document.querySelector("#student-card .student-id"), sid);
    safeText(document.querySelector("#student-card .student-college"), college);
    safeText(document.querySelector("#student-card .student-major"), major);
    safeText(document.querySelector("#student-card .student-grade"), grade);
    safeText(document.querySelector("#student-card .student-dorm"), dorm);

    // 2) 读取可选 student-card 扩展字段（如果后端没有，会被忽略）
    try {
      const { res, data } = await fetchJson(CARD_API, {
        headers: { Authorization: `Bearer ${token2}` },
      });
      if (res.ok) {
        const c = data?.data || data;
        safeText(document.querySelector("#student-card .student-gender"), c?.gender);
        safeText(document.querySelector("#student-card .student-birthday"), c?.birthday);
        safeText(document.querySelector("#student-card .student-enroll"), c?.enroll_date);
        safeText(document.querySelector("#student-card .issue-date-val"), c?.issue_date);
        safeText(document.querySelector("#student-card .validity-val"), c?.valid_until);
        setPhoto(c?.photo_url);
      }
    } catch {
      // ignore
    }
  }

  function openModal() {
    const m = document.getElementById("editModal");
    if (!m) return;
    m.classList.add("show");
    m.setAttribute("aria-hidden", "false");
  }
  function closeModal() {
    const m = document.getElementById("editModal");
    if (!m) return;
    m.classList.remove("show");
    m.setAttribute("aria-hidden", "true");
  }

  function fillFormFromUI() {
    const get = (sel) => document.querySelector(sel)?.textContent?.trim() || "";
    document.getElementById("f_name").value = get("#student-card .student-name");
    document.getElementById("f_college").value = get("#student-card .student-college");
    document.getElementById("f_major").value = get("#student-card .student-major");
    document.getElementById("f_grade").value = get("#student-card .student-grade");

    document.getElementById("f_gender").value = get("#student-card .student-gender");
    document.getElementById("f_birthday").value = get("#student-card .student-birthday");
    document.getElementById("f_enroll").value = get("#student-card .student-enroll");
    document.getElementById("f_issue").value = get("#student-card .issue-date-val");
    document.getElementById("f_valid").value = get("#student-card .validity-val");
    document.getElementById("f_photo").value = "";
  }

  async function saveEdits() {
    if (!token2) {
      alert("请先登录");
      location.replace("/login/");
      return;
    }

    // A) 保存基础资料（一定存在）
    const payload = {
      real_name: document.getElementById("f_name").value.trim(),
      college: document.getElementById("f_college").value.trim(),
      major: document.getElementById("f_major").value.trim(),
      grade: document.getElementById("f_grade").value.trim(),
    };

    const { res: r1, data: d1 } = await fetchJson(`${AUTH_API2}/update`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token2}`,
      },
      body: JSON.stringify(payload),
    });

    if (!r1.ok) {
      alert(d1?.msg || "保存失败（基础资料）");
      return;
    }

    // B) 保存可选 student-card 扩展字段（如果接口不存在/404：忽略）
    const ext = {
      gender: document.getElementById("f_gender").value.trim(),
      birthday: document.getElementById("f_birthday").value.trim(),
      enroll_date: document.getElementById("f_enroll").value.trim(),
      issue_date: document.getElementById("f_issue").value.trim(),
      valid_until: document.getElementById("f_valid").value.trim(),
      photo_url: document.getElementById("f_photo").value.trim(),
    };

    try {
      const { res: r2, data: d2 } = await fetchJson(CARD_API, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token2}`,
        },
        body: JSON.stringify(ext),
      });
      // 404/501 等：说明你还没做后端，跳过即可
      if (!r2.ok && r2.status !== 404) {
        console.warn("student-card save failed:", d2);
      }
    } catch (e) {
      // ignore
    }

    closeModal();
    await loadStudentCard();
    alert("已保存 ✅");
  }

  document.addEventListener("DOMContentLoaded", () => {
    // 打开/关闭 modal
    const openBtn = document.getElementById("edit-card");
    if (openBtn) openBtn.addEventListener("click", () => {
      fillFormFromUI();
      openModal();
    });
    document.getElementById("closeModal")?.addEventListener("click", closeModal);
    document.getElementById("cancelEdit")?.addEventListener("click", closeModal);
    document.getElementById("modalMask")?.addEventListener("click", closeModal);
    document.getElementById("saveEdit")?.addEventListener("click", saveEdits);

    // 首次加载
    loadStudentCard();
  });
</script>

</body>
</html>