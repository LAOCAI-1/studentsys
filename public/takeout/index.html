<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Takeout Monitor</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        margin: 0;
        background: #0b1220;
        color: #e6eefc;
      }
      a {
        color: #9ecbff;
      }
      .wrap {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 16px;
        padding: 16px;
      }
      .card {
        background: #121b2f;
        border: 1px solid #24304f;
        border-radius: 14px;
        padding: 14px;
      }
      h2 {
        margin: 0 0 10px 0;
        font-size: 16px;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      button,
      input,
      select {
        background: #0b1220;
        color: #e6eefc;
        border: 1px solid #24304f;
        border-radius: 10px;
        padding: 8px 10px;
      }
      button {
        cursor: pointer;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        border-bottom: 1px solid #24304f;
        padding: 8px;
        text-align: left;
        vertical-align: top;
      }
      .muted {
        color: #9fb0d0;
      }
      .big {
        font-size: 28px;
        font-weight: 800;
      }
      .grid3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #24304f;
        font-size: 12px;
      }
      .ok {
        border-color: #2b6;
        color: #bfffe0;
      }
      .warn {
        border-color: #f80;
        color: #ffd7ad;
      }
      .bad {
        border-color: #f44;
        color: #ffd0d0;
      }
      img.thumb {
        width: 140px;
        height: auto;
        border-radius: 10px;
        border: 1px solid #24304f;
      }
      .err {
        white-space: pre-wrap;
        color: #ffd0d0;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="row" style="justify-content: space-between">
          <h2>视频预览（可选）</h2>
          <span class="muted">统计与列表来自数据库 /api/takeout/*</span>
        </div>

        <div class="row">
          <button id="btnCam">打开摄像头预览</button>
          <span class="muted"
            >（预览只是看画面，不做画框；画框我们后面再上 WS/推流）</span
          >
        </div>

        <video
          id="v"
          autoplay
          playsinline
          muted
          style="
            width: 100%;
            max-height: 520px;
            border-radius: 12px;
            margin-top: 10px;
            background: #000;
          "
        ></video>

        <div id="errBox" class="err" style="margin-top: 10px"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content: space-between">
          <h2>实时统计</h2>
          <div class="row">
            <label class="muted">窗口(min)</label>
            <input id="minutes" value="60" style="width: 70px" />
            <button id="btnOnce">刷新</button>
            <button id="btnToggle">自动：开</button>
          </div>
        </div>

        <div class="grid3">
          <div class="card" style="padding: 12px">
            <div class="muted">pickup</div>
            <div id="pickup" class="big">0</div>
          </div>
          <div class="card" style="padding: 12px">
            <div class="muted">not_pickup</div>
            <div id="not_pickup" class="big">0</div>
          </div>
          <div class="card" style="padding: 12px">
            <div class="muted">unknown</div>
            <div id="unknown" class="big">0</div>
          </div>
        </div>

        <h2 style="margin-top: 14px">最新事件（最近 20 条）</h2>
        <table>
          <thead>
            <tr>
              <th>时间</th>
              <th>状态</th>
              <th>label</th>
              <th>相似度</th>
              <th>截图</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="muted" style="margin-top: 10px; font-size: 12px">
          依赖接口：
          <span class="pill ok">GET /api/takeout/stats</span>
          <span class="pill ok">GET /api/takeout/events</span>
          （Python 写库用
          <span class="pill warn">POST /api/internal/takeout/event</span>）
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      let timer = null;
      let auto = true;

      function setErr(msg) {
        $("errBox").textContent = msg || "";
      }

      function fmtPct(x) {
        if (x === null || x === undefined) return "-";
        const v = Number(x);
        if (Number.isNaN(v)) return "-";
        return (v * 100).toFixed(1) + "%";
      }

      function badge(status) {
        if (status === "pickup") return `<span class="pill ok">pickup</span>`;
        if (status === "not_pickup")
          return `<span class="pill bad">not_pickup</span>`;
        return `<span class="pill warn">unknown</span>`;
      }

      async function refresh() {
        const minutes = parseInt($("minutes").value || "60", 10);

        try {
          const [s, e] = await Promise.all([
            fetch(`/api/takeout/stats?minutes=${minutes}`).then((r) =>
              r.json()
            ),
            fetch(`/api/takeout/events?limit=20`).then((r) => r.json()),
          ]);

          if (!s.ok) throw new Error("stats failed: " + JSON.stringify(s));
          if (!e.ok) throw new Error("events failed: " + JSON.stringify(e));

          // stats：按 status 聚合
          const map = { pickup: 0, not_pickup: 0, unknown: 0 };
          for (const row of s.byStatus || []) {
            map[row.status] = row.cnt;
          }
          $("pickup").textContent = map.pickup ?? 0;
          $("not_pickup").textContent = map.not_pickup ?? 0;
          $("unknown").textContent = map.unknown ?? 0;

          // events：表格
          const tb = $("tbody");
          tb.innerHTML = "";
          for (const r of e.rows || []) {
            const tr = document.createElement("tr");
            const snap = r.snapshot_url
              ? `<a href="${r.snapshot_url}" target="_blank"><img class="thumb" src="${r.snapshot_url}"/></a>`
              : `<span class="muted">-</span>`;

            tr.innerHTML = `
        <td class="muted">${new Date(r.created_at).toLocaleString()}</td>
        <td>${badge(r.status)}</td>
        <td>${r.label ?? "-"}</td>
        <td>${fmtPct(r.similarity)}</td>
        <td>${snap}</td>
      `;
            tb.appendChild(tr);
          }

          setErr("");
        } catch (err) {
          setErr(String(err));
        }
      }

      $("btnOnce").onclick = refresh;

      $("btnToggle").onclick = () => {
        auto = !auto;
        $("btnToggle").textContent = `自动：${auto ? "开" : "关"}`;
        if (auto && !timer) timer = setInterval(refresh, 1000);
        if (!auto && timer) {
          clearInterval(timer);
          timer = null;
        }
      };

      $("btnCam").onclick = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false,
          });
          $("v").srcObject = stream;
        } catch (err) {
          setErr("摄像头打开失败：" + String(err));
        }
      };

      refresh();
      timer = setInterval(refresh, 1000);
    </script>
  </body>
</html>
