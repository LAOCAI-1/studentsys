<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>福州大学校园管理系统 - 宿舍报修</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    
    <style>
* {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      }
      :root {
        --primary-color: #1a6bc4;
        --secondary-color: #0d4e8c;
        --accent-color: #1a6bc4;
        --light-color: #f0f2f5;
        --dark-color: #333;
        --sidebar-width: 250px;
        --sidebar-collapsed-width: 70px;
        --header-height: 70px;
      }
      body {
        background: #f0f2f5;
        color: #333;
        min-height: 100vh;
        line-height: 1.6;
      }
      .container {
        display: flex;
        min-height: 100vh;
      }

      /* 侧边栏 */
      .sidebar {
        width: var(--sidebar-width);
        background: linear-gradient(
          to bottom,
          var(--secondary-color) 0%,
          var(--primary-color) 100%
        );
        color: #fff;
        transition: all 0.3s;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        z-index: 100;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
      }
      .sidebar.collapsed {
        width: var(--sidebar-collapsed-width);
      }
      .sidebar-header {
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        height: var(--header-height);
      }
      .logo {
        display: flex;
        align-items: center;
      }
      .logo i {
        font-size: 1.5rem;
        margin-right: 10px;
      }
      .logo h1 {
        font-size: 1.2rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
      }
      .sidebar.collapsed .logo h1 {
        display: none;
      }
      .toggle-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.2rem;
        cursor: pointer;
        transition: 0.3s;
      }
      .sidebar.collapsed .toggle-btn {
        transform: rotate(180deg);
      }
      .sidebar-menu {
        padding: 20px 0;
      }
      .menu-item {
        padding: 12px 20px;
        display: flex;
        align-items: center;
        color: rgba(255, 255, 255, 0.85);
        text-decoration: none;
        transition: 0.2s;
        border-left: 3px solid transparent;
        cursor: pointer;
      }
      .menu-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border-left-color: var(--accent-color);
      }
      .menu-item.active {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        border-left-color: #fff;
      }
      .menu-item i {
        margin-right: 15px;
        font-size: 1.1rem;
        width: 20px;
        text-align: center;
      }
      .sidebar.collapsed .menu-item span {
        display: none;
      }
      .menu-divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 15px 0;
      }

      /* 主内容 */
      .main-content {
        flex: 1;
        margin-left: var(--sidebar-width);
        transition: margin-left 0.3s;
      }
      .sidebar.collapsed ~ .main-content {
        margin-left: var(--sidebar-collapsed-width);
      }
      .header {
        height: var(--header-height);
        background: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        position: sticky;
        top: 0;
        z-index: 99;
      }
      .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--dark-color);
        cursor: pointer;
      }
      .user-info {
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      .user-info:hover {
        filter: brightness(0.95);
      }
      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(
          to bottom,
          var(--secondary-color) 0%,
          var(--primary-color) 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        margin-right: 10px;
      }
      .page-content {
        padding: 30px;
      }
      .welcome-section {
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--secondary-color)
        );
        color: #fff;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .welcome-section h1 {
        font-size: 1.8rem;
        margin-bottom: 10px;
      }
      .welcome-section p {
        opacity: 0.95;
        font-size: 1.08rem;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }
      .dashboard-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 25px;
        transition: 0.3s;
        cursor: pointer;
      }
      .dashboard-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
      }
      .card-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }
      .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--secondary-color)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 1.5rem;
        margin-right: 15px;
      }
      .card-header h3 {
        color: var(--dark-color);
        font-size: 1.2rem;
      }
      .card-content p {
        color: #666;
      }

      .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }
      .action-btn {
        background: #fff;
        border: none;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.3s;
      }
      .action-btn:hover {
        background: var(--primary-color);
        color: #fff;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(26, 107, 196, 0.3);
      }
      .action-btn i {
        font-size: 1.8rem;
        margin-bottom: 10px;
      }

      .footer {
        text-align: center;
        padding: 20px;
        color: #666;
        font-size: 0.9rem;
        border-top: 1px solid #eee;
        margin-top: 30px;
      }

      .function-page {
        display: none;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 30px;
        margin-bottom: 30px;
      }
      .function-page.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .page-title {
        font-size: 1.8rem;
        color: var(--dark-color);
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light-color);
      }
      .placeholder-content {
        text-align: center;
        padding: 60px 20px;
        color: #888;
      }
      .placeholder-content i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #dfe5ee;
      }
      .placeholder-content h3 {
        font-size: 1.5rem;
        margin-bottom: 15px;
      }
      .back-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: 0.3s;
        margin-top: 20px;
      }
      .back-btn:hover {
        background: var(--secondary-color);
      }

      /* 宿舍报修 */
      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 20px 0 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
      }
      .repair-section {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .repair-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .add-repair-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: 0.3s;
      }
      .add-repair-btn:hover {
        background: var(--secondary-color);
      }
      .repair-list {
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
      }
      .repair-item {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        transition: 0.2s;
      }
      .repair-item:hover {
        background: #f9f9f9;
      }
      .repair-item:last-child {
        border-bottom: none;
      }
      .repair-type {
        font-weight: 700;
        margin-bottom: 6px;
        color: var(--primary-color);
      }
      .repair-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        margin-bottom: 8px;
      }
      .status-evaluated {
        background: #e8f5e8;
        color: #4caf50;
      }
      .status-transferred {
        background: #fff3cd;
        color: #856404;
      }
      .repair-time,
      .repair-desc {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
      }
      .no-records {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      .form-page,
      .detail-page {
        display: none;
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .form-header,
      .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
      }
      .form-back-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 16px;
      }
      .form-back-btn i {
        margin-right: 6px;
      }
      .form-group {
        margin-bottom: 18px;
      }
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
      }
      .required::after {
        content: "*";
        color: #f00;
        margin-left: 4px;
      }
      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }
      .form-textarea {
        height: 100px;
        resize: vertical;
      }
      .char-count {
        text-align: right;
        font-size: 12px;
        color: #999;
        margin-top: 5px;
      }
      .image-upload {
        border: 1px dashed #ddd;
        border-radius: 6px;
        padding: 20px;
        text-align: center;
        color: #999;
        cursor: pointer;
      }
      .image-upload-icon {
        font-size: 24px;
        margin-bottom: 10px;
      }
      .submit-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
        transition: 0.3s;
      }
      .submit-btn:hover {
        background: var(--secondary-color);
      }

      /* 报修详情 + 评价 */
      .detail-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 18px;
      }
      .detail-item {
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 6px;
        padding: 12px;
      }
      .detail-label {
        font-size: 12px;
        color: #777;
        margin-bottom: 5px;
      }
      .detail-value {
        font-weight: 600;
        color: #222;
      }
      .evaluation-section {
        margin-top: 14px;
        border-top: 1px dashed #e0e0e0;
        padding-top: 12px;
      }
      .evaluation-textarea {
        width: 100%;
        min-height: 90px;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        resize: vertical;
        margin: 10px 0;
      }
      .submit-evaluation {
        background: #1db954;
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
      }
      .submit-evaluation:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      @media (max-width: 992px) {
        .sidebar {
          width: var(--sidebar-collapsed-width);
        }
        .sidebar .logo h1,
        .sidebar .menu-item span {
          display: none;
        }
        .main-content {
          margin-left: var(--sidebar-collapsed-width);
        }
        .dashboard-grid {
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }
      }
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }
        .sidebar.active {
          transform: translateX(0);
          width: var(--sidebar-width);
        }
        .sidebar.active .logo h1,
        .sidebar.active .menu-item span {
          display: block;
        }
        .main-content {
          margin-left: 0;
        }
        .mobile-menu-btn {
          display: block;
        }
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
        .repair-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .add-repair-btn {
          margin-top: 10px;
        }
        .detail-content {
          grid-template-columns: 1fr;
        }
      }

#dorm-repair { padding: 20px; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <i class="fas fa-graduation-cap"></i>
            <h1>福州大学校园管理系统</h1>
          </div>
          <button class="toggle-btn" id="toggle-btn" title="收起/展开侧边栏">
            <i class="fas fa-chevron-left"></i>
          </button>
        </div>

        <div class="sidebar-menu">
          <a class="menu-item" href="/dashboard/"><i class="fas fa-home"></i><span>系统概览</span></a>
          <a class="menu-item" href="/face/"><i class="fas fa-user-check"></i><span>人脸识别</span></a>
          <a class="menu-item" href="/campus-map/"><i class="fas fa-map-marked-alt"></i><span>校园地图</span></a>
          <a class="menu-item active" href="/repair/"><i class="fas fa-tools"></i><span>宿舍报修</span></a>
          <a class="menu-item" href="/student-id/"><i class="fas fa-id-card"></i><span>学生证展示</span></a>
          <a class="menu-item" href="/love/"><i class="fas fa-heart"></i><span>宿舍表白墙</span></a>
          <a class="menu-item" href="/profile/"><i class="fas fa-user"></i><span>个人中心</span></a>
          <div class="menu-divider"></div>
          <a class="menu-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>退出登录</span></a>
        </div>
      </div>
      <div class="main-content">
        <div class="header">
          <button class="mobile-menu-btn" id="mobile-menu-btn">
            <i class="fas fa-bars"></i>
          </button>
          <div class="user-info" id="user-info" title="点击查看个人中心">
            <div class="user-avatar" id="user-avatar">学</div>
            <div>
              <div id="user-name">同学</div>
              <div id="user-college" style="font-size: 0.8rem; color: #666">学院</div>
            </div>
          </div>
        </div>

        <div class="page-content">
          <div class="function-page active" id="dorm-repair">
            <h2 class="page-title">宿舍报修</h2>
            <div class="repair-section">
              <div class="repair-header">
                <h2>宿舍报修记录</h2>
                <button class="add-repair-btn" id="addRepairBtn">
                  <i class="fas fa-plus"></i> 新增报修
                </button>
              </div>

              <!-- 列表 -->
              <div id="listPage" class="list-page">
                <div class="repair-list" id="repairList"></div>
              </div>

              <!-- 表单 -->
              <div id="formPage" class="form-page">
                <div class="form-header">
                  <button class="form-back-btn" id="backToListBtn">
                    <i class="fas fa-arrow-left"></i> 返回列表
                  </button>
                  <h2>新增报修申请</h2>
                  <span></span>
                </div>

                <div class="form-group">
                  <label class="form-label required">手机号</label
                  ><input
                    id="phoneInput"
                    type="tel"
                    class="form-input"
                    placeholder="请输入手机号"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label required">报修类型</label>
                  <select id="typeSelect" class="form-select">
                    <option value="">请选择</option>
                    <option value="电器">电器维修</option>
                    <option value="水务">水务维修</option>
                    <option value="家具">家具维修</option>
                    <option value="其他">其他维修</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label required">报修校区</label>
                  <select id="campusSelect" class="form-select">
                    <option value="旗山校区">旗山校区</option>
                    <option value="仓山校区">仓山校区</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label required">报修片区</label>
                  <select id="areaSelect" class="form-select">
                    <option value="研究生公寓B区">研究生公寓B区</option>
                    <option value="本科生公寓A区">本科生公寓A区</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label required">报修宿舍楼</label>
                  <select id="buildingSelect" class="form-select">
                    <option value="63号楼">63号楼</option>
                    <option value="64号楼">64号楼</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label required">详细地点</label
                  ><input
                    id="locationInput"
                    type="text"
                    class="form-input"
                    placeholder="请输入详细地点，如 525"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label required">问题描述</label>
                  <textarea
                    id="problemTextarea"
                    class="form-textarea"
                    placeholder="请输入问题描述"
                  ></textarea>
                  <div class="char-count" id="problemCount">0/1000</div>
                </div>
                <div class="form-group">
                  <label class="form-label">备注</label>
                  <textarea
                    id="remarkTextarea"
                    class="form-textarea"
                    placeholder="请输入备注"
                  ></textarea>
                  <div class="char-count" id="remarkCount">0/1000</div>
                </div>
                <div class="form-group">
                  <label class="form-label">故障图片</label>
                  <div class="image-upload" id="imageUpload">
                    <div class="image-upload-icon">
                      <i class="fas fa-camera"></i>
                    </div>
                    <div id="imageText">点击上传图片</div>
                  </div>
                  <input
                    type="file"
                    id="fileInput"
                    accept="image/*"
                    style="display: none"
                  />
                </div>

                <button class="submit-btn" id="submitBtn">提交报修</button>
              </div>

              <!-- 详情 -->
              <div id="detailPage" class="detail-page">
                <div class="detail-header">
                  <button class="form-back-btn" id="backToListFromDetailBtn">
                    <i class="fas fa-arrow-left"></i> 返回列表
                  </button>
                  <h2>报修详情</h2>
                  <span></span>
                </div>

                <div class="detail-content">
                  <div class="detail-item">
                    <div class="detail-label">报修类型</div>
                    <div class="detail-value" id="detailType">-</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">处理状态</div>
                    <div class="detail-value" id="detailStatus"></div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">报修时间</div>
                    <div class="detail-value" id="detailTime">-</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">问题描述</div>
                    <div class="detail-value" id="detailDesc">-</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">报修地点</div>
                    <div class="detail-value" id="detailLocation">-</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">维修人员</div>
                    <div class="detail-value" id="detailRepairer">-</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">完成时间</div>
                    <div class="detail-value" id="detailCompleteTime">-</div>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">维修说明</div>
                    <div class="detail-value" id="detailRepairNote">-</div>
                  </div>
                </div>

                <div class="evaluation-section">
                  <h3>评价维修服务</h3>
                  <textarea
                    class="evaluation-textarea"
                    placeholder="请输入您的评价"
                    disabled
                  ></textarea>
                  <button class="submit-evaluation" disabled>已评价</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="footer">福州大学校园管理系统 © 2025</div>
      </div>
    </div>
    <script>
  /* ======= 基础工具 & 登录守卫（同源，不写死端口） ======= */
  const ORIGIN = location.origin;
  const AUTH_API = `${ORIGIN}/api/auth`;
  const token = localStorage.getItem("token");

  function go(path) {
    location.href = path.startsWith("http") ? path : `${ORIGIN}${path}`;
  }

  // 允许 login 页不拦截；其余页无 token 直接回到登录
  if (!token && !location.pathname.startsWith("/login")) {
    alert("请先登录！");
    location.replace(`${ORIGIN}/login/`);
  }

  async function loadProfile() {
    // 先用缓存渲染（更快）
    try {
      const cached = JSON.parse(localStorage.getItem("user") || "null");
      if (cached) renderUser(cached);
    } catch {}

    // 再从后端刷新（更准）
    try {
      const res = await fetch(`${AUTH_API}/profile`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (!res.ok) throw new Error("profile not ok");
      const j = await res.json();
      const u = j?.data || j?.user || j;
      if (u) {
        localStorage.setItem("user", JSON.stringify(u));
        renderUser(u);
      }
    } catch (e) {
      // 没取到就保持缓存/默认
    }
  }

  function renderUser(u) {
    const name = u.real_name || u.name || u.username || "同学";
    const college = u.college || u.department || "学院";
    const avatarChar = name?.trim()?.[0] || "学";
    const nameEl = document.getElementById("user-name");
    const colEl = document.getElementById("user-college");
    const avEl = document.getElementById("user-avatar");
    if (nameEl) nameEl.textContent = name;
    if (colEl) colEl.textContent = college;
    if (avEl) avEl.textContent = avatarChar;
  }

  // 顶部个人资料卡
  document.addEventListener("DOMContentLoaded", () => {
    const userInfo = document.getElementById("user-info");
    if (userInfo) userInfo.addEventListener("click", () => go("/profile/"));

    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        go("/login/");
      });
    }

    // 侧边栏收起/展开
    const toggleBtn = document.getElementById("toggle-btn");
    if (toggleBtn) {
      toggleBtn.addEventListener("click", () => {
        document.getElementById("sidebar")?.classList.toggle("collapsed");
      });
    }

    // 移动端展开/收起
    const mobileBtn = document.getElementById("mobile-menu-btn");
    if (mobileBtn) {
      mobileBtn.addEventListener("click", () => {
        document.getElementById("sidebar")?.classList.toggle("active");
      });
    }

    // 点击主内容区域（小屏收起侧边栏）
    document.querySelector(".main-content")?.addEventListener("click", () => {
      if (innerWidth <= 768) document.getElementById("sidebar")?.classList.remove("active");
    });

    // 通用返回按钮
    document.querySelectorAll(".back-btn").forEach((btn) => {
      btn.addEventListener("click", () => go("/dashboard/"));
    });

    loadProfile();
  });
</script>
    <script>
/* ======= 宿舍报修（后端优先，失败回退本地示例） ======= */
      const fallbackRecords = [
        {
          id: 1,
          type: "其他维修/门",
          status: "已评价",
          time: "2025.09.24 17:33",
          desc: "门关上会卡，最后一段很难拉",
          location: "研究生公寓B区 63号楼 525",
          repairer: "李师傅 (13512345678)",
          completeTime: "2025.09.25 10:15",
          repairNote: "已更换门锁零件，问题已解决",
          evaluation: "维修师傅很专业，很快就解决了问题，服务态度很好！",
        },
        {
          id: 2,
          type: "其他维修/宿舍渗水",
          status: "已评价",
          time: "2025.09.13 00:16",
          desc: "浴室堵水",
          location: "研究生公寓B区 63号楼 525",
          repairer: "王师傅 (13512345679)",
          completeTime: "2025.09.13 15:30",
          repairNote: "已疏通下水道，问题已解决",
          evaluation: "响应很快，问题解决彻底",
        },
        {
          id: 3,
          type: "电器/空调",
          status: "已评价",
          time: "2025.09.13 00:15",
          desc: "空调漏水，上个学期就申报了，一直没修，整个...",
          location: "研究生公寓B区 63号楼 525",
          repairer: "张师傅 (13512345680)",
          completeTime: "2025.09.14 11:20",
          repairNote: "已清理空调排水管，问题已解决",
          evaluation: "终于修好了，等了很久但服务不错",
        },
      ];

      let listPage,
        formPage,
        detailPage,
        repairList,
        addRepairBtn,
        backToListBtn,
        backToListFromDetailBtn,
        submitBtn,
        imageUpload,
        fileInput,
        phoneInput,
        typeSelect,
        campusSelect,
        areaSelect,
        buildingSelect,
        locationInput,
        problemTextarea,
        remarkTextarea;
      let currentRecords = [];

      async function fetchRepairList() {
        try {
          const res = await fetch(`${REPAIRS_API}/my`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (res.ok) {
            const j = await res.json();
            return j?.data ?? [];
          }
        } catch {}
        return fallbackRecords;
      }

      function initRepairPage() {
        listPage = document.getElementById("listPage");
        formPage = document.getElementById("formPage");
        detailPage = document.getElementById("detailPage");
        repairList = document.getElementById("repairList");
        addRepairBtn = document.getElementById("addRepairBtn");
        backToListBtn = document.getElementById("backToListBtn");
        backToListFromDetailBtn = document.getElementById(
          "backToListFromDetailBtn"
        );
        submitBtn = document.getElementById("submitBtn");
        imageUpload = document.getElementById("imageUpload");
        fileInput = document.getElementById("fileInput");
        phoneInput = document.getElementById("phoneInput");
        typeSelect = document.getElementById("typeSelect");
        campusSelect = document.getElementById("campusSelect");
        areaSelect = document.getElementById("areaSelect");
        buildingSelect = document.getElementById("buildingSelect");
        locationInput = document.getElementById("locationInput");
        problemTextarea = document.getElementById("problemTextarea");
        remarkTextarea = document.getElementById("remarkTextarea");

        bindCount(problemTextarea, document.getElementById("problemCount"));
        bindCount(remarkTextarea, document.getElementById("remarkCount"));

        if (!initRepairPage._bound) {
          addRepairBtn.addEventListener("click", () => {
            listPage.style.display = "none";
            formPage.style.display = "block";
          });
          backToListBtn.addEventListener("click", () => {
            formPage.style.display = "none";
            listPage.style.display = "block";
          });
          backToListFromDetailBtn.addEventListener("click", () => {
            detailPage.style.display = "none";
            listPage.style.display = "block";
          });
          imageUpload.addEventListener("click", () => fileInput.click());
          fileInput.addEventListener("change", (e) => {
            document.getElementById("imageText").textContent = e.target.files
              .length
              ? `已选择：${e.target.files[0].name}`
              : "点击上传图片";
          });
          submitBtn.addEventListener("click", submitRepair);
          initRepairPage._bound = true;
        }

        (async () => {
          currentRecords = await fetchRepairList();
          displayRepairRecords();
        })();
      }

      function bindCount(textarea, countEl) {
        textarea.addEventListener("input", function () {
          const n = this.value.length;
          countEl.textContent = `${n}/1000`;
          countEl.style.color = n > 1000 ? "#f00" : "#999";
        });
      }

      function displayRepairRecords() {
        repairList.innerHTML = "";
        if (!currentRecords || currentRecords.length === 0) {
          repairList.innerHTML = '<div class="no-records">暂无申报记录</div>';
          return;
        }
        currentRecords.forEach((rec) => {
          const statusClass =
            rec.status === "已评价" ? "status-evaluated" : "status-transferred";
          const div = document.createElement("div");
          div.className = "repair-item";
          div.innerHTML = `
            <div class="repair-type">${rec.type || "-"}</div>
            <div class="repair-status ${statusClass}">处理状态 ${
            rec.status || "处理中"
          }</div>
            <div class="repair-time">报修时间 ${rec.time || "-"}</div>
            <div class="repair-desc">问题描述 ${rec.desc || "-"}</div>
          `;
          div.addEventListener("click", () => showDetailPage(rec));
          repairList.appendChild(div);
        });
      }

      function showDetailPage(rec) {
        listPage.style.display = "none";
        detailPage.style.display = "block";
        const statusClass =
          rec.status === "已评价" ? "status-evaluated" : "status-transferred";
        document.getElementById("detailType").textContent = rec.type || "-";
        document.getElementById(
          "detailStatus"
        ).innerHTML = `<span class="repair-status ${statusClass}">${
          rec.status || "处理中"
        }</span>`;
        document.getElementById("detailTime").textContent = rec.time || "-";
        document.getElementById("detailDesc").textContent = rec.desc || "-";
        document.getElementById("detailLocation").textContent =
          rec.location || "-";
        document.getElementById("detailRepairer").textContent =
          rec.repairer || "-";
        document.getElementById("detailCompleteTime").textContent =
          rec.completeTime || "-";
        document.getElementById("detailRepairNote").textContent =
          rec.repairNote || "-";

        const eva = document.querySelector(".evaluation-textarea");
        const btn = document.querySelector(".submit-evaluation");
        if (rec.evaluation) {
          eva.value = rec.evaluation;
          eva.disabled = true;
          btn.disabled = true;
          btn.textContent = "已评价";
        } else {
          eva.value = "";
          eva.disabled = false;
          btn.disabled = false;
          btn.textContent = "提交评价";
          // 可在此补 POST /api/repairs/{id}/evaluate
          btn.onclick = () => {
            alert("评价已提交！");
            eva.disabled = true;
            btn.disabled = true;
            btn.textContent = "已评价";
          };
        }
      }

      async function submitRepair() {
        const payload = {
          phone: (phoneInput.value || "").trim(),
          repair_type: typeSelect.value,
          campus: campusSelect.value,
          zone: areaSelect.value,
          building: buildingSelect.value,
          room: (locationInput.value || "").trim(),
          description: (problemTextarea.value || "").trim(),
          remark: (remarkTextarea.value || "").trim(),
        };
        if (
          !payload.phone ||
          !payload.repair_type ||
          !payload.campus ||
          !payload.zone ||
          !payload.building ||
          !payload.room ||
          !payload.description
        ) {
          alert("请填写所有必填项");
          return;
        }

        let ok = false,
          created = null;
        try {
          const res = await fetch(`${REPAIRS_API}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(payload),
          });
          if (res.ok) {
            const j = await res.json();
            created = j?.data || null;
            ok = true;
          }
        } catch {}

        if (!ok) {
          created = {
            id: Date.now(),
            type: `${payload.repair_type}`,
            status: "已转派",
            time: new Date().toISOString().replace("T", " ").slice(0, 16),
            desc: payload.description,
            location: `${payload.zone} ${payload.building} ${payload.room}`,
            repairer: "",
            completeTime: "",
            repairNote: "",
          };
        }
        currentRecords = [created, ...(currentRecords || [])];

        alert("报修申请已提交！");
        formPage.style.display = "none";
        listPage.style.display = "block";
        displayRepairRecords();

        // reset
        phoneInput.value = "";
        typeSelect.value = "";
        campusSelect.value = "旗山校区";
        areaSelect.value = "研究生公寓B区";
        buildingSelect.value = "63号楼";
        locationInput.value = "";
        problemTextarea.value = "";
        document.getElementById("problemCount").textContent = "0/1000";
        remarkTextarea.value = "";
        document.getElementById("remarkCount").textContent = "0/1000";
        document.getElementById("imageText").textContent = "点击上传图片";
        fileInput.value = "";
      }

// 本页只展示报修模块：进入即初始化
document.addEventListener('DOMContentLoaded', () => {
  try { initRepairPage(); } catch(e) { console.warn(e); }
});
</script>
  </body>
</html>